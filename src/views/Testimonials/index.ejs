<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head', { title: title || 'Testimonials' }) %>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
  <style>
    /* small push down */
    .feedback-section{ margin-top: 28px; }
    .form-card, .latest-card{ margin-top: 10px; }
  </style>
</head>
<body class="feedback-ui">
  <%- include('../partials/header') %>

  <!-- HERO -->
  <section class="feedback-header-section">
    <div class="container-wide feedback-hero">
      <div>
        <h1><i class="fas fa-comment-dots"></i> Share your feedback</h1>
        <p>Your insights help us improve fast. Rate your experience and tell us what worked — and what didn’t.</p>
      </div>
      <div class="feedback-hero-art">
        <img class="hero-img" src="/img/feedback-hero.png" alt="Feedback illustration" onerror="this.remove()">
        <div class="hero-blob"></div>
      </div>
    </div>
  </section>

  <!-- MAIN: left form + right latest -->
  <main class="feedback-section" id="feedbackTop">
    <div class="container-narrow two-col">

      <% /* ---- SAFE LOCALS ---- */ %>
      <%
        const fbs =
          (typeof feedbacks !== 'undefined' && Array.isArray(feedbacks)) ? feedbacks :
          (typeof items      !== 'undefined' && Array.isArray(items))      ? items      :
          [];

        const csrf = (typeof csrfToken !== 'undefined' && csrfToken) ? csrfToken : '';
        const d    = (typeof data      !== 'undefined' && data)      ? data      : {};

        // Always render only the latest 5 on this page
        const latestFive = fbs.slice(0, 5);
      %>

      <!-- LEFT: FORM -->
      <section class="card form-card">
        <div class="card-header">Write your feedback</div>
        <div class="card-body">
          <% if (typeof error !== 'undefined' && error) { %>
            <div class="error"><%- error %></div>
          <% } %>

          <!-- SINGLE-LINE SUCCESS BANNER -->
          <% if (typeof success !== 'undefined' && success) { %>
            <div
              style="
                display:flex;align-items:center;gap:8px;
                padding:8px 12px;margin:10px 0;
                border-left:4px solid #16a34a;background:#ecfdf5;color:#065f46;
                border-radius:10px;font-weight:600;line-height:1.2;max-width:100%;
                white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-wrap:nowrap;
              "
              title="<%- success %>"
            >
              <i class="fa-solid fa-check"></i>
              <span style="white-space:inherit;overflow:hidden;text-overflow:ellipsis;"><%- success %></span>
            </div>
          <% } %>

          <form action="/testimonials" method="POST" class="feedback-form" id="feedbackForm" novalidate>
            <% if (csrf) { %><input type="hidden" name="_csrf" value="<%= csrf %>"><% } %>

            <div class="rating-row">
              <div class="label-title">Rating</div>
              <div class="rating" id="ratingStars" aria-label="Select a rating from 1 to 5">
                <input type="radio" id="rate5" name="rating" value="5" <%= (+d.rating===5)?'checked':'' %> required>
                <label for="rate5" title="5 stars"><i class="fa-solid fa-star"></i></label>

                <input type="radio" id="rate4" name="rating" value="4" <%= (+d.rating===4)?'checked':'' %>>
                <label for="rate4" title="4 stars"><i class="fa-solid fa-star"></i></label>

                <input type="radio" id="rate3" name="rating" value="3" <%= (+d.rating===3)?'checked':'' %>>
                <label for="rate3" title="3 stars"><i class="fa-solid fa-star"></i></label>

                <input type="radio" id="rate2" name="rating" value="2" <%= (+d.rating===2)?'checked':'' %>>
                <label for="rate2" title="2 stars"><i class="fa-solid fa-star"></i></label>

                <input type="radio" id="rate1" name="rating" value="1" <%= (+d.rating===1)?'checked':'' %>>
                <label for="rate1" title="1 star"><i class="fa-solid fa-star"></i></label>
              </div>
            </div>

            <label for="name">Your name</label>
            <input id="name" class="f-input" type="text" name="name" placeholder="e.g., Ritika Poudel"
                   required value="<%= d.name || '' %>">

            <label for="message" style="margin-top:10px">Feedback</label>
            <textarea id="message" class="f-textarea" name="message"
                      placeholder="Tell us what worked well and what could be improved..." required><%= d.message || '' %></textarea>

            <div class="submit-wrap">
              <button class="submit-btn" type="submit"><i class="fas fa-paper-plane"></i> Submit Feedback</button>
            </div>
          </form>
        </div>
      </section>

      <!-- RIGHT: LATEST (only 5) -->
      <aside class="card latest-card">
        <div class="card-header">Latest feedback</div>
        <div class="card-body">
          <div class="latest-list">
            <% if (latestFive.length === 0) { %>
              <div class="latest-item">
                <div class="latest-body">No feedback yet. Be the first to share your thoughts!</div>
              </div>
            <% } else { latestFive.forEach(fb => { const r = Math.max(0, Math.min(5, Number(fb.rating)||0)); %>
              <div class="latest-item">
                <div class="latest-head">
                  <span><%= fb.name || 'Guest' %></span>
                  <span class="latest-stars" aria-label="<%= r %> stars">
                    <% for (let s=0; s<r; s++){ %><i class="fa-solid fa-star"></i><% } %>
                    <% for (let s=r; s<5; s++){ %><i class="fa-regular fa-star"></i><% } %>
                  </span>
                </div>
                <div class="latest-body"><%= fb.message %></div>
                <% if (fb.created_at) { %>
                  <div class="latest-time"><i class="far fa-clock"></i>
                    <%= new Date(fb.created_at).toLocaleString() %>
                  </div>
                <% } %>
              </div>
            <% }); } %>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <%- include('../partials/footer') %>

  <script>
    // Star picker
    (function(){
      const rating = document.getElementById('ratingStars');
      if (!rating) return;
      function checkFromLabel(lab){
        const id = lab?.getAttribute('for');
        const input = id && document.getElementById(id);
        if (input) input.checked = true;
      }
      rating.addEventListener('click', (e)=>{
        const lab = e.target.closest('label');
        if (lab && rating.contains(lab)) checkFromLabel(lab);
      });
      function updateFromPointer(e){
        const el = document.elementFromPoint(e.clientX, e.clientY);
        const lab = el && el.closest && el.closest('label');
        if (lab && rating.contains(lab)) checkFromLabel(lab);
      }
      rating.addEventListener('pointerdown', (e)=>{
        rating.setPointerCapture?.(e.pointerId);
        updateFromPointer(e);
        rating.dataset.dragging = '1';
      });
      rating.addEventListener('pointermove', (e)=>{
        if (rating.dataset.dragging === '1') updateFromPointer(e);
      });
      ['pointerup','pointercancel','pointerleave'].forEach(ev=>{
        rating.addEventListener(ev, ()=>{ rating.dataset.dragging = '0'; });
      });
    })();

    // Simple required check to mirror server-side validation
    (function(){
      const form = document.getElementById('feedbackForm');
      if (!form) return;
      form.addEventListener('submit', function(e){
        const name = (document.getElementById('name')?.value || '').trim();
        const rating = document.querySelector('input[name="rating"]:checked');
        const msg = (document.getElementById('message')?.value || '').trim();
        if (!name || !rating || !msg) {
          e.preventDefault();
          alert('All fields are required.');
        }
      });
    })();
  </script>
</body>
</html>
