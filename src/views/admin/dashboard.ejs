<!doctype html>
<html lang="en">
<head>
  <%- include('../partials/head', { title: (title || 'Admin â€¢ Jay Mahalaxmi') }) %>

  <!-- (Optional) Font Awesome for the other icons used in cards/headers -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

  <style>
    :root{
      --bg-1:#0e172a; --bg-2:#0c1426; --text:#e6edf7; --muted:#a5b4c7;
      --brand:#2c6bff; --brand-2:#60a5fa; --brand-3:#93c5fd;
      --nav:#0f1e3b; --pill:#274785; --card:#121b2f99; --card-hover:#162444cc;
      --card-border:#6e89bc33; --radius:14px; --shadow:0 10px 30px rgba(4,13,33,.26);
      --good:#16a34a; --warn:#f59e0b; --info:#60a5fa; --bad:#ef4444;
    }
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 10% -10%, #142344 0%, transparent 60%),
        radial-gradient(1000px 600px at 85% -20%, #0f2448 0%, transparent 60%),
        linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 55%, #0b1528 100%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    .container{max-width:1200px; margin:0 auto; padding:28px 22px 40px}
    h1{margin:0 0 10px; font-size:42px; line-height:1.1; font-weight:900}
    .sub{margin:0 0 18px; color:var(--muted)}

    /* KPI STRIP */
    .kpis{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:14px; margin-bottom:18px}
    @media (max-width:860px){ .kpis{grid-template-columns:1fr} }
    .kpi{
      background:linear-gradient(180deg,#0f1b34,#0c162c);
      border:1px solid var(--card-border); border-radius:var(--radius);
      padding:16px; box-shadow:var(--shadow);
      display:flex; align-items:center; gap:12px;
    }
    .kpi .ico{
      width:44px; height:44px; border-radius:12px; display:grid; place-items:center;
      background:rgba(20,42,85,.6); border:1px solid #27478588; flex:0 0 auto;
      color:#e6edf7; /* default icon color */
    }
    .kpi .ico.good { color: var(--good); }
    .kpi .ico.info { color: var(--info); }
    .kpi .ico.warn { color: var(--warn); }
    /* inline SVG sizing & color */
    .kpi .ico svg{ width:22px; height:22px; display:block; fill:currentColor; }

    .kpi .meta{display:flex; flex-direction:column}
    .kpi .meta .lbl{color:#a9b8d4; font-size:.85rem}
    .kpi .meta .val{font-size:1.6rem; font-weight:900; letter-spacing:.2px}

    /* ENTITY CARDS */
    .cards{display:flex; gap:18px; flex-wrap:wrap}
    .card{
      flex:1 1 260px; min-width:260px; background:var(--card); border:1px solid var(--card-border);
      border-radius:var(--radius); padding:18px 16px; box-shadow:var(--shadow); cursor:pointer; transition:.15s; outline:none;
    }
    .card:hover{transform:translateY(-2px); background:var(--card-hover); border-color:#6e89bc55}
    .card:focus-visible{box-shadow:0 0 0 3px rgba(44,107,255,.4), var(--shadow)}
    .card h3{margin:0; font-size:1.05rem; font-weight:800; display:flex; gap:8px; align-items:center}
    .card p{margin:8px 0 0; color:#cbd7ea; font-size:.95rem}
    .card strong{color:#fff}

    /* BELOW: equal columns (chart â†” activity) */
    .below{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:18px;
      margin-top:22px;
    }
    @media (max-width:1100px){ .below{grid-template-columns:1fr} }

    /* OVERALL PIE (left) */
    .overall{
      background:linear-gradient(180deg,#111b33ee,#0e1830ee);
      border:1px solid #6e89bc33; border-radius:var(--radius); padding:16px; box-shadow:var(--shadow);
    }
    .overall h2{margin:0 0 6px; font-size:1rem; font-weight:900}
    .overall .muted{color:#a9b8d4; margin:0 0 10px}

    /* Center the chart inside the card */
    .chart-wrap{
      height:280px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    canvas{
      display:block;
      height:100% !important;
      width:auto !important;
      max-width:520px;
    }

    .nodata{padding:10px 12px; color:#a9b8d4; background:#0f1b34; border:1px dashed #27478555; border-radius:12px}

    /* Custom legend (always white) */
    .legend{
      margin-top:10px; display:grid; gap:10px;
      justify-content:center; text-align:left;
      color:#fff; font-weight:800;
    }
    .legend .row{ display:flex; align-items:center; gap:10px; }
    .legend .swatch{ width:28px; height:14px; border-radius:3px; flex:0 0 auto; }
    .legend .label{ white-space:nowrap; }
    @media (min-width:640px){ .legend{ grid-template-columns:repeat(2, max-content); } }

    /* RECENT ACTIVITY (right) */
    .activity{
      background:linear-gradient(180deg,#0f1b34,#0c162c);
      border:1px solid var(--card-border); border-radius:var(--radius);
      padding:14px; box-shadow:var(--shadow); color:#e8f1ff;
      display:flex; flex-direction:column; min-height:360px;
    }
    .activity h3{margin:2px 0 10px; font-size:1rem; font-weight:900}
    .timeline{
      list-style:none; padding:0; margin:0;
      flex:1 1 auto; overflow:auto;
    }
    .timeline li{display:flex; gap:10px; padding:10px 2px; border-bottom:1px dashed #27478555}
    .timeline li:last-child{border-bottom:none}
    .dot{ width:9px; height:9px; border-radius:999px; margin-top:7px; background:var(--brand-2); box-shadow:0 0 0 3px rgba(96,165,250,.18) }
    .content{min-width:0}
    .line{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .line strong{font-weight:800}
    .line .muted{color:#9fb2d6; font-size:.85rem}
    .sub{color:#c8d6ef}
    .see-more{ margin-top:12px; display:flex; justify-content:flex-end; }
    .see-more a{
      border:1px solid #88a1d533; background:#182a50; color:#e9f0ff; border-radius:8px; padding:8px 12px; text-decoration:none; font-weight:700;
    }
    .see-more a:hover{ background:#1a2f5a }
  </style>
</head>

<body>
  <%- include('../partials/adminheader', { active: 'dashboard', csrfToken: csrfToken }) %>

  <main class="container">
    <h1>Welcome, <%= adminUsername %> ðŸ‘‹</h1>
    <p class="sub">Hereâ€™s a quick overview of your site.</p>

    <!-- KPIs -->
    <section class="kpis" aria-label="Key Performance Indicators">
      <!-- Products today -->
      <div class="kpi" role="status" aria-live="polite">
        <div class="ico good" aria-hidden="true">
          <!-- boxes stack -->
          <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
            <path d="M3 7.5l9 4 9-4-9-4-9 4zm0 2.7v6.3l8.2 3.6V13.8L3 10.2zm10.8 9.9L21 16.5v-6.3l-8.2 3.6v6.3z"/>
          </svg>
        </div>
        <div class="meta">
          <span class="lbl">Products added today</span>
          <span class="val"><%= typeof newProductsToday !== 'undefined' ? newProductsToday : 0 %></span>
        </div>
      </div>

      <!-- Blog posts this week -->
      <div class="kpi">
        <div class="ico info" aria-hidden="true">
          <!-- newspaper -->
          <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
            <path d="M3 5h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5zm2 2v10h12V7H5zm14 3h2v7a3 3 0 0 1-3 3H6v-2h12a1 1 0 0 0 1-1V10zM7 9h6v2H7V9zm0 3h6v2H7v-2z"/>
          </svg>
        </div>
        <div class="meta">
          <span class="lbl">Blog Posts published this week</span>
          <span class="val"><%= typeof blogThisWeek !== 'undefined' ? blogThisWeek : 0 %></span>
        </div>
      </div>

      <!-- Testimonials this month -->
      <div class="kpi">
        <div class="ico warn" aria-hidden="true">
          <!-- star half -->
          <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
            <path d="M12 2l2.9 6 6.6.9-4.8 4.6 1.2 6.5L12 17l-5.9 3.1 1.2-6.5L2.5 8.9l6.6-.9L12 2zM11 5.6v9.5l-3.6 1.9.7-3.9-2.9-2.8 4-.5L11 5.6z"/>
          </svg>
        </div>
        <div class="meta">
          <span class="lbl">Testimonials this month</span>
          <span class="val"><%= typeof testiThisMonth !== 'undefined' ? testiThisMonth : 0 %></span>
        </div>
      </div>
    </section>

    <!-- Cards -->
    <section class="cards" aria-label="Entities">
      <div class="card" role="button" tabindex="0" onclick="location.href='/admin/products'">
        <h3><i class="fas fa-cubes"></i> Total Products</h3>
        <p>Total: <strong><%= typeof totalProducts !== 'undefined' ? totalProducts : 0 %></strong></p>
      </div>
      <div class="card" role="button" tabindex="0" onclick="location.href='/admin/testimonials?status=pending'">
        <h3><i class="fas fa-comments"></i> Total Testimonials</h3>
        <p>Total: <strong><%= typeof totalTestimonials !== 'undefined' ? totalTestimonials : 0 %></strong></p>
      </div>
      <div class="card" role="button" tabindex="0" onclick="location.href='/admin/blog'">
        <h3><i class="fas fa-newspaper"></i> Total Blog</h3>
        <p>Total: <strong><%= typeof totalBlogPosts !== 'undefined' ? totalBlogPosts : 0 %></strong></p>
      </div>
      <div class="card" role="button" tabindex="0" onclick="location.href='/admin/messages'">
        <h3><i class="fas fa-envelope-open-text"></i> Total Contact</h3>
        <p>Total: <strong><%= typeof totalContacts !== 'undefined' ? totalContacts : 0 %></strong></p>
      </div>
    </section>

    <!-- Chart + Activity -->
    <section class="below">
      <!-- Overall doughnut -->
      <section class="overall" aria-label="Overall overview">
        <h2><i class="fas fa-chart-pie"></i> Overall Overview</h2>
        <p class="muted">Distribution across entities (Products, Testimonials, Blog Posts, Contacts).</p>

        <div id="noData" class="nodata" style="display:none;">No data yet to display.</div>

        <div class="chart-wrap">
          <canvas id="overallChart"
                  aria-label="Overall chart"
                  data-products="<%= typeof totalProducts !== 'undefined' ? totalProducts : 0 %>"
                  data-testimonials="<%= typeof totalTestimonials !== 'undefined' ? totalTestimonials : 0 %>"
                  data-blogposts="<%= typeof totalBlogPosts !== 'undefined' ? totalBlogPosts : 0 %>"
                  data-contacts="<%= typeof totalContacts !== 'undefined' ? totalContacts : 0 %>"></canvas>
        </div>

        <!-- Custom legend (white text guaranteed) -->
        <div id="overallLegend" class="legend" aria-label="Overall legend"></div>
      </section>

      <!-- Recent Activity -->
      <aside class="activity" aria-label="Recent activity">
        <h3><i class="fas fa-stream"></i> Recent Activity</h3>
        <ul class="timeline">
          <% if (Array.isArray(recentActivity) && recentActivity.length) { %>
            <% (recentActivity || []).slice(0,6).forEach(a => { %>
              <li>
                <span class="dot"></span>
                <div class="content">
                  <div class="line">
                    <strong><%= a.title %></strong>
                    <span class="muted">â€¢ <%= a.when %></span>
                  </div>
                  <% if (a.detail) { %><div class="sub"><%= a.detail %></div><% } %>
                </div>
              </li>
            <% }) %>
          <% } else { %>
            <li>
              <span class="dot"></span>
              <div class="content">
                <div class="line"><strong>No activity yet</strong></div>
                <div class="sub">Create a product, publish a blog post, or receive a message to see updates here.</div>
              </div>
            </li>
          <% } %>
        </ul>
<!-- 
        <% if (Array.isArray(recentActivity) && recentActivity.length > 6) { %>
          <div class="see-more">
            <a href="/admin/activity" aria-label="See more activity">See more</a>
          </div>
        <% } %> -->
      </aside>
    </section>
  </main>

  <script nonce="<%= cspNonce %>">
    (function(){
      function ready(fn){ if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn); else fn(); }

      ready(function(){
        const canvas  = document.getElementById('overallChart');
        const legendC = document.getElementById('overallLegend');
        const noData  = document.getElementById('noData');
        if (!canvas) return;

        const waitForChart = (cb)=>{
          if (window.Chart) return cb();
          let tries = 0; const t = setInterval(()=>{ if (window.Chart || ++tries>80){ clearInterval(t); if (window.Chart) cb(); }}, 50);
        };

        waitForChart(function(){
          Chart.defaults.color = '#ffffff';
          Chart.defaults.plugins.legend.display = false; // custom legend

          const ds = canvas.dataset;
          const labels = ['Products','Testimonials','Blog Posts','Contacts'];
          const values = [
            Number(ds.products || 0),
            Number(ds.testimonials || 0),
            Number(ds.blogposts || 0),
            Number(ds.contacts || 0),
          ];
          const colors = ['#f59e0b','#16a34a','#60a5fa','#ef4444'];

          const total = values.reduce((a,b)=>a+b,0);
          if (!total){ noData.style.display='block'; canvas.style.display='none'; legendC.innerHTML=''; return; }
          noData.style.display='none'; canvas.style.display='block';

          const ctx = canvas.getContext('2d');
          new Chart(ctx, {
            type: 'doughnut',
            data: { labels, datasets: [{ data: values, backgroundColor: colors, borderColor:'rgba(255,255,255,.12)', borderWidth:1, hoverOffset:10 }] },
            options: {
              responsive: true,
              cutout: '58%',
              interaction: { mode: 'nearest', intersect: true },
              onHover: (evt, el) => { evt.native.target.style.cursor = el.length ? 'pointer' : 'default'; },
              plugins: {
                tooltip: {
                  enabled: true,
                  position: 'nearest',
                  backgroundColor: 'rgba(15,27,52,0.95)',
                  borderColor: 'rgba(255,255,255,.18)',
                  borderWidth: 1,
                  titleColor: '#fff',
                  bodyColor:  '#fff',
                  callbacks: {
                    label: (ctx) => {
                      const v = Number(ctx.parsed || 0);
                      const pct = total ? ((v/total)*100).toFixed(1) : 0;
                      return `${ctx.label}: ${v} (${pct}%)`;
                    }
                  }
                }
              }
            }
          });

          // Custom legend
          const rows = labels.map((lbl,i)=>{
            const v = Number(values[i] || 0);
            const pct = total ? ((v/total)*100).toFixed(1) : '0.0';
            return `
              <div class="row">
                <span class="swatch" style="background:${colors[i]};"></span>
                <span class="label">${lbl}: ${v} (${pct}%)</span>
              </div>`;
          }).join('');
          legendC.innerHTML = rows;
        });
      });
    })();
  </script>
</body>
</html>
