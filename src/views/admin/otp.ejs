<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head', { title: 'Verify OTP' }) %>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        crossorigin="anonymous"/>

  <style>
    html, body { height: 100%; }
    body{
      margin:0;
      min-height:100vh; min-height:100dvh;
      display:grid; place-items:center;
      color:#e8eeff; background:#0a1227;
      overflow:hidden; isolation:isolate;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans";
    }

    .bg-gradient{ position:fixed; inset:0; z-index:0;
      background: radial-gradient(1200px 800px at 18% -5%, #15254c 0%, #0f1a36 48%, #0b1327 100%);
    }
    .bg-gradient::before{
      content:""; position:absolute; inset:0; opacity:.35; pointer-events:none;
      background:
        linear-gradient(to right, rgba(140,168,230,.10) 1px, transparent 1px) 0 0/36px 36px,
        linear-gradient(to bottom, rgba(140,168,230,.10) 1px, transparent 1px) 0 0/36px 36px,
        linear-gradient(to right, rgba(120,150,220,.08) 1px, transparent 1px) 0 0/144px 144px,
        linear-gradient(to bottom, rgba(120,150,220,.08) 1px, transparent 1px) 0 0/144px 144px;
    }

    #bgBlobs, #bgLinks{
      position:fixed; inset:0; z-index:1; pointer-events:none;
      width:100vw; height:100vh;
    }
    #bgLinks{ z-index:2; }

    .wrap{ width:min(520px, 94vw); padding:18px; z-index:3; }
    .card{
      background: linear-gradient(180deg, rgba(26,39,68,.92), rgba(18,28,52,.90));
      border: 1px solid rgba(95,123,180,.35);
      border-radius: 16px;
      padding: 28px 26px 22px;
      box-shadow: 0 16px 44px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.05);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    }
    h1{ margin:0 0 8px; font-size: clamp(22px, 3.6vw, 28px); color:#f4f7ff; }
    p.sub{ margin:0 0 16px; color:#aab6d6; }

    .error{ color:#ffd8d8; background:rgba(255,88,88,.10); border:1px solid rgba(255,88,88,.35);
      padding:10px 12px; border-radius:10px; margin:0 0 14px; font-weight:600; }

    label{ display:block; margin:10px 0 6px; font-size:14px; color:#cfd9ff; }
    input[type="text"]{
      width:100%; padding:12px 14px; border:1px solid rgba(121,146,210,.28);
      background:#0b1327; color:#e6edff; border-radius:10px; font-size:18px; letter-spacing:.35em; text-align:center;
      outline:none; transition:border-color .25s, box-shadow .25s, background-color .25s;
    }
    input[type="text"]:focus{ background:#0a1130; border-color:#88a3ff; box-shadow:0 0 0 4px rgba(136,163,255,.18); }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      margin-top:14px; width:100%;
      padding:12px 16px; border:0; border-radius:10px; cursor:pointer;
      background: linear-gradient(90deg, #6f87ff, #8aa6ff);
      color:#0b1022; font-weight:800; font-size:16px;
      box-shadow:0 12px 26px rgba(111,135,255,.35);
      transition: transform .06s, filter .2s, box-shadow .2s;
    }
    .btn:hover{ filter:brightness(1.04); }
    .btn:active{ transform:translateY(1px); }
  </style>
</head>
<body>
  <div class="bg-gradient" aria-hidden="true"></div>
  <canvas id="bgBlobs"></canvas>
  <canvas id="bgLinks"></canvas>

  <main class="wrap">
    <section class="card">
      <h1>Verify OTP</h1>
      <% if (typeof error !== 'undefined' && error) { %>
        <div class="error"><%- error %></div>
      <% } %>
      <p class="sub">We sent a 6-digit code to <b><%= email %></b>. It expires in 5 minutes.</p>

      <form method="post" action="/admin/otp" autocomplete="one-time-code">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <label for="code">Code</label>
        <input id="code" type="text" name="code" inputmode="numeric" minlength="6" maxlength="6" required>
        <button class="btn" type="submit"><i class="fa-solid fa-shield-check"></i> Verify</button>
      </form>
    </section>
  </main>

  <!-- Same spread blobs -->
  <script nonce="<%= cspNonce || '' %>">
    (function(){
      const c = document.getElementById('bgBlobs');
      if(!c) return;
      const ctx = c.getContext('2d');
      let w,h,dpr,blobs=[],t=0;

      function resize(){
        dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1));
        w=window.innerWidth; h=window.innerHeight;
        c.width=Math.floor(w*dpr); c.height=Math.floor(h*dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
        seed();
      }
      function seed(){
        blobs.length=0;
        const xs=[0.18,0.50,0.82], ys=[0.22,0.50,0.78];
        const baseR=Math.min(w,h)*0.32, jitter=Math.min(w,h)*0.03;
        for(const gx of xs) for(const gy of ys){
          const ax=gx*w+(Math.random()*2-1)*jitter;
          const ay=gy*h+(Math.random()*2-1)*jitter;
          blobs.push({
            ax,ay, x:ax,y:ay,
            r:baseR*(0.45+Math.random()*0.5),
            hue:200+Math.random()*35,
            a:0.06+Math.random()*0.08,
            vx:(Math.random()*2-1)*0.10,
            vy:(Math.random()*2-1)*0.10,
            wob:0.7+Math.random()*0.8
          });
        }
      }
      function loop(){
        ctx.clearRect(0,0,w,h);
        t+=0.02;
        ctx.globalCompositeOperation='lighter';
        for(const b of blobs){
          b.x+=(b.ax-b.x)*0.025+b.vx+Math.sin(t*b.wob)*0.16;
          b.y+=(b.ay-b.y)*0.025+b.vy+Math.cos(t*b.wob)*0.16;
          const g=ctx.createRadialGradient(b.x,b.y,0,b.x,b.y,b.r);
          g.addColorStop(0,`hsla(${b.hue},85%,72%,${b.a})`);
          g.addColorStop(1,`hsla(${b.hue},85%,72%,0)`);
          ctx.fillStyle=g; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
        }
        ctx.globalCompositeOperation='source-over';
        requestAnimationFrame(loop);
      }
      window.addEventListener('resize', resize, {passive:true});
      window.addEventListener('load', () => { resize(); requestAnimationFrame(loop); });
    })();
  </script>

  <!-- Same nodes + links -->
  <script nonce="<%= cspNonce || '' %>">
    (function(){
      const canvas=document.getElementById('bgLinks'); if(!canvas) return;
      const ctx=canvas.getContext('2d'); let w,h,dpr,nodes=[];
      const CFG={maxDist:150,nodeSize:2.6,nodeGlow:3.8,lineAlpha:.22,nodeAlpha:.96,speed:.14};

      function resize(){
        dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1));
        w=window.innerWidth; h=window.innerHeight;
        canvas.width=Math.floor(w*dpr); canvas.height=Math.floor(h*dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0); seed();
      }
      function addCluster(cx,cy,count,spread){
        for(let i=0;i<count;i++){
          const a=Math.random()*Math.PI*2, r=(Math.random()*0.6+0.4)*spread;
          nodes.push({x:cx+Math.cos(a)*r,y:cy+Math.sin(a)*r,
                      vx:(Math.random()*2-1)*CFG.speed, vy:(Math.random()*2-1)*CFG.speed,
                      z:0.6+Math.random()*0.8});
        }
      }
      function seed(){
        nodes=[];
        addCluster(w*0.70,h*0.40,12,80);
        addCluster(w*0.32,h*0.62, 9,70);
        addCluster(w*0.44,h*0.48, 5,50);
        addCluster(w*0.38,h*0.30, 3,28);
      }
      function draw(){
        ctx.clearRect(0,0,w,h);
        const g=ctx.createRadialGradient(w*0.60,h*0.42,0,w*0.60,h*0.42,Math.max(w,h)*0.9);
        g.addColorStop(0,'rgba(120,185,255,.07)'); g.addColorStop(1,'rgba(0,0,0,0)');
        ctx.fillStyle=g; ctx.fillRect(0,0,w,h);

        for(const p of nodes){
          p.x+=p.vx*(0.8+p.z); p.y+=p.vy*(0.8+p.z);
          if(p.x<-20) p.x=w+20; if(p.x>w+20) p.x=-20;
          if(p.y<-20) p.y=h+20; if(p.y>h+20) p.y=-20;
        }
        for(let i=0;i<nodes.length;i++){
          const a=nodes[i];
          for(let j=i+1;j<nodes.length;j++){
            const b=nodes[j], dx=a.x-b.x, dy=a.y-b.y, d=Math.hypot(dx,dy);
            if(d<CFG.maxDist){
              const t=1-d/CFG.maxDist;
              ctx.strokeStyle=`rgba(140,170,230,${CFG.lineAlpha*t})`;
              ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
            }
          }
        }
        for(const p of nodes){
          ctx.beginPath(); ctx.fillStyle=`rgba(200,220,255,${CFG.nodeAlpha})`;
          ctx.arc(p.x,p.y,CFG.nodeSize*p.z,0,Math.PI*2); ctx.fill();
          ctx.beginPath(); ctx.fillStyle='rgba(120,180,255,.22)';
          ctx.arc(p.x,p.y,CFG.nodeSize*p.z*CFG.nodeGlow,0,Math.PI*2); ctx.fill();
        }
        requestAnimationFrame(draw);
      }
      window.addEventListener('resize', resize, {passive:true});
      window.addEventListener('load', () => { resize(); requestAnimationFrame(draw); });
    })();
  </script>
</body>
</html>
